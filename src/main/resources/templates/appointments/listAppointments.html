<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml"
      th:replace="~{fragments/layout :: layout (~{::body},'appointments',#{appointment.CustomerAppointments})}">

<body>

<!-- Page Content -->
<div class="row align-items-center justify-content-center" style="margin-top: 50px">
    <div th:fragment="customerAppointments">


        <table id="appointments" class="table text-center">
            <thead class="thead-dark">
            <tr>
                <th th:text="#{appointment.Work}"> Work</th>
                <th th:text="#{appointment.Status}"> Status</th>
                <th th:text="#{appointment.Start}"> Start</th>
                <th sec:authorize="!hasRole('ROLE_PROVIDER')" th:text="#{appointment.Provider}"> Provider</th>
                <th sec:authorize="!hasRole('ROLE_CUSTOMER')" th:text="#{appointment.Customer}"> Customer</th>
                <th th:text="#{appointment.Duration}"> Duration</th>
                <th th:text="#{appointment.Action}"> Action</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${appointments == null}">
                <td colspan="2" th:text="#{appointment.NoAppointmentsAvailable}"> No Appointments Available</td>
            </tr>
            <tr th:each="appointment : ${appointments}"
                th:classappend="${appointment.status.name() == 'CANCELED' || appointment.status.name()  == 'FINISHED' || appointment.status.name()  == 'INVOICED' || appointment.status.name()  == 'REJECTION_REQUESTED' || appointment.status.name()  == 'REJECTED'} ? table-secondary : table-success">
                <td><span th:text="${appointment.work.name}"> Work </span></td>
                <td><span th:text="${#messages.msg('status.' + appointment.status)}"> scheduled </span></td>
                <td><span th:text="${#temporals.format(appointment.start, 'yyyy-MM-dd HH:mm')}"> 21-01-2019 15:00</span>
                </td>
                <td sec:authorize="!hasRole('ROLE_PROVIDER')"><span
                        th:text="${appointment.provider.firstName + ' ' + appointment.provider.lastName}">
                                Provider </span>
                </td>
                <td sec:authorize="!hasRole('ROLE_CUSTOMER')"><span
                        th:text="${appointment.customer?.firstName + ' ' + appointment.customer?.lastName}">
                                Customer </span>
                </td>
                <td><span th:text="${appointment.work.duration}">60</span><span> </span><span th:text="#{appointment.min}">min</span></td>
                <td><a class="btn btn-secondary" th:href="@{'/appointments/' + ${appointment.id}}"
                       role="button" th:text="#{button.Details}">Details</a></td>
            </tr>
            </tbody>
            <tfoot class="text-primary">
            <tr>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th  sec:authorize="hasRole('ROLE_ADMIN')"></th>
            </tr>
            </tfoot>
        </table>
        <div sec:authorize="hasRole('ROLE_CUSTOMER')" class="text-center">
            <a class="btn btn-primary mt-2" th:href="@{/appointments/new}" role="button" th:text="#{button.NewAppointment}">New appointment</a>
        </div>
        <div sec:authorize="hasRole('ROLE_PROVIDER')" class="text-center">
            <a class="btn btn-primary mt-2" th:href="@{/appointments/add-slot}" role="button" th:text="#{button.AddSlot}">Add slot</a>
        </div>

    </div>

    <script>
        $(document).ready(function () {
            $('#appointments').DataTable({
                "dom": '<"toolbar">lrtip',
                "bFilter": true,
                "bLengthChange": false,
                "language": {
					url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/ru.json',
                },
                "order": [
                    [2, "asc"]
                ],
                "initComplete": function () {
                    this.api().columns([1]).every(function () {
                        $("div.toolbar").html('<div id="my_filter" style="margin-bottom: 10px">[[#{appointment.StatusFilter}]]: </div>');
                        var column = this;
                        column.search('^SCHEDULED$', true, false).draw();
                        var select = $('<select name="statuses"><option value="[[#{status.SCHEDULED}]]">[[#{status.SCHEDULED}]]</option></select>')
                            .appendTo('#my_filter')
                            .on('change', function () {
                                var searchString = $(this).val();
                                searchString = searchString.replace('<span>', '');
                                searchString = searchString.replace('</span>', '');
                                var val = $.fn.dataTable.util.escapeRegex(searchString);
                                column.search(val ? '^' + val + '$' : '', true, false).draw();
                            });
                        /*statuses.forEach(function (d) {*/
                        select.append('<option value="[[#{status.AVAILABLE}]]">[[#{status.AVAILABLE}]]</option>')
                        select.append('<option value="[[#{status.FINISHED}]]">[[#{status.FINISHED}]]</option>')
                        select.append('<option value="[[#{status.CONFIRMED}]]">[[#{status.CONFIRMED}]]</option>')
                        select.append('<option value="[[#{status.INVOICED}]]">[[#{status.INVOICED}]]</option>')
                        select.append('<option value="[[#{status.CANCELED}]]">[[#{status.CANCELED}]]</option>')
                        select.append('<option value="[[#{status.DENIED}]]">[[#{status.DENIED}]]</option>')
                        select.append('<option value="[[#{status.REJECTION_REQUESTED}]]">[[#{status.REJECTION_REQUESTED}]]</option>')
                        select.append('<option value="[[#{status.REJECTED}]]">[[#{status.REJECTED}]]</option>')
                        select.append('<option value="[[#{status.EXCHANGE_REQUESTED}]]">[[#{status.EXCHANGE_REQUESTED}]]</option>')
                        /*});*/
                    });
                }
            });
        });

        var statuses = [
            'FINISHED',
            'CONFIRMED',
            'INVOICED',
            'CANCELED',
            'DENIED',
            'REJECTION_REQUESTED',
            'REJECTED',
            'EXCHANGE_REQUESTED'];
    </script>
</div>


</body>


</html>